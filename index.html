<canvas id='main' moz-opaque width='400' height='400'></canvas>
<script>
  let xv = 0
  let yv = 0
  const gridSize = 20

  window.onload = function () {
    const canvas = document.getElementById('main')
    if (canvas.getContext) {
      const ctx = canvas.getContext('2d')
      clear(ctx, canvas)
      document.addEventListener('keydown', keyPress)
      let snake = new Snake()
      let food = new Food()

      setInterval(function () {
        clear(ctx, canvas)
        tick(snake, food, ctx)
      }, 1000 / 15)
    }
  }

  class Snake {
    constructor () {
      this.snakeX = Math.floor(Math.random() * gridSize)
      this.snakeY = Math.floor(Math.random() * gridSize)
      this.tailLength = 3
      this.tail = []

      this.snakeY += this.tailLength
      while (this.tail.length !== this.tailLength) {
        this.tail.push({x: this.snakeX, y: this.snakeY--})
      }
    }
    handleTail () {
      this.tail.push({x: this.snakeX, y: this.snakeY})
      while (this.tail.length > this.tailLength) {
        this.tail.shift()
      }
    }
    draw (ctx) {
      ctx.fillStyle = 'green'
      ctx.fillRect(this.snakeX * gridSize, this.snakeY * gridSize, gridSize - 2, gridSize - 2)
      for (let i = 0; i < this.tail.length; i++) {
        ctx.fillRect(this.tail[i].x * gridSize, this.tail[i].y * gridSize, gridSize - 2, gridSize - 2)
      }
    }
    move () {
      if (xv !== 0 || yv !== 0) {
        this.handleTail()
        this.snakeX += xv
        this.snakeY += yv
        for (let i = 0; i < this.tail.length; i++) {
          if (this.checkCollision(this.tail[i])) {
            reset()
            break
          }
        }
      }
    }
    checkCollision (item) {
      if (this.snakeX === item.snakeX && this.snakeY === item.snakeY) {
        return true
      }
    }
    grow () {
      this.tailLength++
    }
  }

  class Food {
    constructor () {
      this.x = Math.floor(Math.random() * gridSize)
      this.y = Math.floor(Math.random() * gridSize)
    }
    draw (ctx) {
      ctx.fillStyle = 'blue'
      ctx.fillRect(this.x * gridSize, this.y * gridSize, gridSize - 2, gridSize - 2)
    }
  }

  function clear (ctx, canvas) {
    ctx.fillStyle = 'black'
    ctx.fillRect(0, 0, canvas.width, canvas.height)
  }

  function keyPress (event) {
    switch (event.keyCode) {
      case 37:
        xv = -1
        yv = 0
        break
      case 38:
        xv = 0
        yv = -1
        break
      case 39:
        xv = 1
        yv = 0
        break
      case 40:
        xv = 0
        yv = 1
        break
    }
  }

  function reset (snake, food, ctx) {
    console.log('lose')
  }

  function tick (snake, food, ctx) {
    snake.move()
    snake.draw(ctx)
    if (snake.checkCollision(food)) console.log('hello')
    food.draw(ctx)
  }
</script>
